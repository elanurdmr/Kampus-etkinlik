name: Auto Generate PBI Issues and Add to Project

on:
  workflow_dispatch:

  pull_request:
    types:
      - closed   # Merge edildiğinde tetiklenmesi için

  push:
    branches:
      - main     # Manuel push olursa yine tetikler

jobs:
  generate:
    # PR closed event geldiyse → sadece merged ise çalıştır
    if: >
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    runs-on: ubuntu-latest

    env:
      PROJECT_ID: PVT_kwHOCQuiAM4BIXwI   # Senin gerçek project ID’n

    steps:
      - uses: actions/checkout@v3

      # Modern ve sorunsuz GH CLI kurulumu (apt-key hatası YOK)
      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || sudo apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
            | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
            | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Load JSON into lines
        run: jq -c '.[]' .github/pbi-list.json > pbi_rows.txt

      - name: Create Issues + Add to Project
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          while IFS= read -r row; do
            ID=$(echo "$row" | jq -r '.id')
            TITLE=$(echo "$row" | jq -r '.title')
            DESC=$(echo "$row" | jq -r '.desc')
            CAT=$(echo "$row" | jq -r '.cat')

            echo "Processing PBI $ID - $TITLE"

            # Bu PBI daha önce oluşturulmuş mu?
            EXIST=$(gh issue list --search "PBI $ID" --json number | jq '.[0].number')

            if [ "$EXIST" != "null" ]; then
              echo "Issue PBI $ID already exists, skipping."
              ISSUE_NUMBER=$EXIST
            else
              # Yeni issue oluştur
              ISSUE_NUMBER=$(gh issue create \
                --title "PBI $ID - $TITLE" \
                --body "$DESC" \
                --label "$CAT" \
                --label "priority-medium" \
                --json number | jq -r '.number')
            fi

            # Node ID çek
            ISSUE_NODE=$(gh issue view $ISSUE_NUMBER --json node_id -q '.node_id')

            # Projeye ekle
            gh api graphql -f query='
              mutation($project:ID!, $content:ID!) {
                addProjectV2ItemById(input: {
                  projectId: $project
                  contentId: $content
                }) {
                  item { id }
                }
              }
            ' -f project=$PROJECT_ID -f content=$ISSUE_NODE

          done < pbi_rows.txt
