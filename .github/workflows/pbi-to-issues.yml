name: Auto Generate PBI Issues and Add to Project

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: PVT_kwHOCQuiAM4BIXwI

    steps:
      - uses: actions/checkout@v3

      # GH CLI manual install (BU KESİN ÇALIŞIR)
      - name: Install GitHub CLI manually
        run: |
          curl -fsSL https://github.com/cli/cli/releases/latest/download/gh_2.63.0_linux_amd64.deb -o ghcli.deb
          sudo dpkg -i ghcli.deb
          sudo apt-get install -f -y

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Load JSON rows
        run: jq -c '.[]' .github/pbi-list.json > rows.txt

      - name: Create Issues and add to project
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          while IFS= read -r row; do
            ID=$(echo "$row" | jq -r '.id')
            TITLE=$(echo "$row" | jq -r '.title')
            DESC=$(echo "$row" | jq -r '.desc')
            CAT=$(echo "$row" | jq -r '.cat')

            echo "Processing PBI $ID - $TITLE"

            EXIST=$(gh issue list --search "PBI $ID" --json number | jq '.[0].number')

            if [ "$EXIST" != "null" ]; then
              echo "Issue exists → skipping"
              ISSUE_NUMBER=$EXIST
            else
              ISSUE_NUMBER=$(gh issue create \
                --title "PBI $ID - $TITLE" \
                --body "$DESC" \
                --label "$CAT" \
                --json number | jq -r '.number')
            fi

            ISSUE_NODE=$(gh issue view $ISSUE_NUMBER --json node_id -q '.node_id')

            gh api graphql -f query='
              mutation($project:ID!, $content:ID!) {
                addProjectV2ItemById(input: {
                  projectId: $project
                  contentId: $content
                }) {
                  item { id }
                }
              }
            ' -f project=$PROJECT_ID -f content=$ISSUE_NODE

          done < rows.txt
